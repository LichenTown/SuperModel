name: Build Resource Pack and Deploy Item ID Page

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Cache Deno modules
        run: deno cache main.ts

      - name: Build Pack
        run: deno run --allow-all --unstable-ffi main.ts build

      - name: Locate build directory
        id: locate
        shell: bash
        run: |
          set -euo pipefail
          BUILD_DIR=$(find build -mindepth 1 -maxdepth 1 -type d | head -n 1)
          if [ -z "$BUILD_DIR" ]; then
            echo "No build output found under ./build" >&2
            exit 1
          fi
          PACK_BASENAME=$(basename "$BUILD_DIR")
          echo "build_dir=$BUILD_DIR" >> $GITHUB_OUTPUT
          echo "pack_name=$PACK_BASENAME" >> $GITHUB_OUTPUT

      - name: Compute SHA1 of resource pack directory
        id: sha
        shell: bash
        run: |
          set -euo pipefail
          # Create a deterministic zip in memory for hashing purposes
          cd "${{ steps.locate.outputs.build_dir }}"
          ZIP_CONTENT=$(find . -type f | sort | xargs cat | sha1sum | awk '{print $1}')
          echo "$ZIP_CONTENT" > "../${ZIP_CONTENT}.txt"
          echo "sha=$ZIP_CONTENT" >> $GITHUB_OUTPUT

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "Latest Resource Pack Build"
          body: "Automatic build of the resource pack. \n\n**SHA-1 Checksum:** `${{ steps.sha.outputs.sha }}`"
          files: |
            ${{ steps.locate.outputs.pack_name }}.zip
            ${{ steps.locate.outputs.pack_name }}.sha1

      - name: Prepare Pages content
        id: pages
        shell: bash
        run: |
          set -euo pipefail
          DIST_DIR="dist-pages"
          mkdir -p "$DIST_DIR"
          # Prefer repo root index.html; else fallback to generated summary (renamed to index.html)
          if [ -f index.html ]; then
            cp index.html "$DIST_DIR/index.html"
          elif [ -f build/assets/supermodel/item-models.html ]; then
            cp build/assets/supermodel/item-models.html "$DIST_DIR/index.html"
          else
            echo "No index.html found in repo root or generated summary. Creating placeholder." >&2
            cat > "$DIST_DIR/index.html" << 'EOF'
          <!doctype html><meta charset="utf-8"><title>Resource Pack</title>
          <h1>No index.html found</h1>
          <p>Add an index.html to repo root or ensure generator produces item-models.html.</p>
          EOF
          fi
          echo "dir=$DIST_DIR" >> $GITHUB_OUTPUT

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ steps.pages.outputs.dir }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
